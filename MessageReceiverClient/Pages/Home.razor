@page "/"
@using MessageReceiverClient.Services
@using MessageReceiverClient.Models
@inject WebSocketService WebSocketService
@implements IDisposable

<h3>Полученные Сообщения</h3>

@if (messages == null)
{
    <p>Загрузка...</p>
}
else if (!messages.Any())
{
    <p>Сообщений пока нет.</p>
}
else
{
    <ul class="list-group">
        @foreach (var message in messages)
        {
            <li class="list-group-item">
                <strong>@message.SequenceNumber:</strong> @message.Text <br />
                <small>@message.Timestamp.ToLocalTime()</small>
            </li>
        }
    </ul>
}

@code {
    private List<Message> messages;

    protected override async Task OnInitializedAsync()
    {
        messages = new List<Message>();
        WebSocketService.OnMessageReceived += HandleMessageReceived;
        await WebSocketService.ConnectAsync();
    }

    private void HandleMessageReceived(Message message)
    {
        InvokeAsync(() =>
        {
            messages.Add(message);
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        WebSocketService.OnMessageReceived -= HandleMessageReceived;
    }
}

